---
title: "ETF5500 Group Assignment"
format: pdf
author: Girika, Jyovika Aswale, Richa Anghan, Sia Chawla, Siddhi Ajit Jadhav
---

```{r, message=FALSE}
library(tidyverse)
library(zoo)
```


```{r}
market_df <- read.csv(here::here("data/Market.csv"))
sample_df <- read.csv(here::here("data/SampleK.csv"))
```

```{r, IDA results='hide', echo=FALSE}
colSums(is.na(sample_df))

range(sample_df$Date)

tibble(stock = names(sample_df)[-1]) %>%
  mutate(industry = substr(stock,1,1)) %>%
  count(industry)
```

## Cleaning 
```{r, CLeaning}
sample_df <- sample_df %>%
  mutate(Date = as.yearmon(str_remove(Date, "Y"), format = "%Y M%m"))

market_df <- market_df %>%
  mutate(Date = as.yearmon(str_remove(Date, "Y"), format = "%Y M%m"))
  
```

## EDA

```{r, EDA }
stocks_long <- sample_df %>%
  pivot_longer(-Date, names_to = "stock", values_to = "ret") %>%
  mutate(industry = substr(stock,1,1),
         industry_name = recode(industry,
           B = "Mining",
           C = "Construction",
           D = "Manufacturing",
           E = "Transport & Utilities",
           F = "Wholesale Trade",
           G = "Retail Trade",
           H = "Finance/Insurance/RE",
           I = "Services"
         ))

industry_summary <- stocks_long %>%
  group_by(industry_name) %>%
  summarise(
    mean_return = mean(ret, na.rm = TRUE),
    sd_return   = sd(ret, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(industry_summary, aes(x = reorder(industry_name, mean_return),
                             y = mean_return, fill = industry_name)) +
  geom_col() +
  coord_flip() +  
  labs(title = "Average Monthly Return by Industry",
       x = "Industry", y = "Mean Return") +
  theme_minimal() +
  theme(legend.position = "none")

sampleXmarket <- stocks_long %>%
  left_join(market_df, by = "Date")

industry_ts <- sampleXmarket %>%
  group_by(Date, industry_name) %>%
  summarise(
    avg_ret = mean(ret, na.rm = TRUE),
    MarketReturn = first(MarketReturn),  
    .groups = "drop"
  )

ggplot(industry_ts, aes(x = MarketReturn, y = avg_ret, color = industry_name)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  facet_wrap(~ industry_name, scales = "fixed") +
  labs(
    title = "Industry Average Returns vs Market Return",
    x = "Market Return",
    y = "Industry Avg Return"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

##PCA

```{r}
pca_out <- prcomp(sample_df[,-1], scale. = TRUE)
plot(pca_out, type = "line")

summary(pca_out)
biplot(pca_out, scale = 0, main = "Distance biplot")
```
## Question 1
```{r}
pc_scores <- as.data.frame(pca_out$x)   
pc1_scores <- pc_scores$PC1

pca_vs_market <- tibble(
  Date = sample_df$Date,  
  PC1 = pc1_scores
) %>%
  left_join(market_df, by = "Date")

cor(pca_vs_market$PC1, pca_vs_market$MarketReturn, use = "pairwise.complete.obs")


ggplot(pca_vs_market, aes(x = MarketReturn, y = PC1)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "PC1 vs Market Return",
    x = "Market Return",
    y = "PC1 Score"
  ) +
  theme_minimal()



```

## Notes 

The first principal component (PC1) explains the largest proportion of variance in the stock return dataset (~27%). When we compare PC1 to the market return (S&P500), we observe a very strong linear relationship, with a high absolute correlation. Although the relationship is negative, this is a result of PCA’s arbitrary sign convention — flipping the direction of PC1 would make the correlation positive. Thus, PC1 can be interpreted as capturing the broad market factor, consistent with the belief that the largest principal component coincides with market movements.


## References

Date formating using zoo in R. (2017, January). [Online post]. <https://stackoverflow.com/questions/41588737/date-formating-using-zoo-in-r?rq=3>
